<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>M.I.B. (Message In a Bottle) - App Finale</title>
    
    <!-- PWA e Icone per iPhone/Android/Browser -->
    <!-- ?v=2 forza l'aggiornamento della cache delle immagini -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png?v=2">
    <link rel="icon" type="image/png" href="icon.png?v=2">
    <link rel="shortcut icon" type="image/png" href="icon.png?v=2">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#111827">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        .icon { width: 24px; height: 24px; display: inline-block; vertical-align: middle; }
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(74, 222, 128, 0); }
            100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); }
        }
        .online-indicator { animation: pulse-green 2s infinite; }

        /* NUOVO: Animazione Glow per messaggi freschi */
        @keyframes glow-pulse {
            0% { box-shadow: 0 0 5px rgba(74, 222, 128, 0.2); }
            50% { box-shadow: 0 0 15px rgba(74, 222, 128, 0.5); }
            100% { box-shadow: 0 0 5px rgba(74, 222, 128, 0.2); }
        }
        .message-glow { animation: glow-pulse 3s infinite ease-in-out; }
        
        /* SCROLL NATURALE (Senza blocchi) */
        body { 
            background-color: #111827; 
            min-height: 100vh;
        }

        /* Stile per il banner iOS */
        #ios-install-prompt {
            box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
            animation: slide-up 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            border-top: 1px solid #374151;
        }
        @keyframes slide-up {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        
        /* Icone Onboarding iOS */
        .safari-share {
            display: inline-block; width: 20px; height: 20px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 50 50' enable-background='new 0 0 50 50'%3E%3Cpath fill='%233b82f6' d='M30.3,13.7L25,8.4l-5.3,5.3l-1.4-1.4L25,5.6l6.7,6.7L30.3,13.7z'/%3E%3Cpath fill='%233b82f6' d='M24,7v21h2V7H24z'/%3E%3Cpath fill='%233b82f6' d='M35,44H15c-1.7,0-3-1.3-3-3V22c0-1.7,1.3-3,3-3h7v2h-7c-0.6,0-1,0.4-1,1v19c0,0.6,0.4,1,1,1h20c0.6,0,1-0.4,1-1V22 c0-0.6-0.4-1-1-1h-7v-2h7c1.7,0,3,1.3,3,3v19C38,42.7,36.7,44,35,44z'/%3E%3C/svg%3E");
            background-size: contain; background-repeat: no-repeat; vertical-align: text-bottom;
        }
        .chrome-share {
            display: inline-block; width: 20px; height: 20px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%233b82f6'%3E%3Cpath d='M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z'/%3E%3C/svg%3E");
            background-size: contain; background-repeat: no-repeat; vertical-align: text-bottom;
        }
    </style>
</head>
<body class="text-white">

    <div id="app" class="w-full max-w-lg mx-auto relative pb-10">
        
        <!-- PARTE SUPERIORE (Scorre via quando scendi) -->
        <div class="p-4 sm:p-8 pb-2">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-3xl font-bold text-center text-green-500 flex items-center tracking-widest">
                    <svg class="w-7 h-7 text-green-500 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                    <span>M.I.B.</span>
                </h1>
                
                <!-- Indicatore Utenti Online -->
                <div id="online-users-badge" class="hidden flex items-center bg-gray-800 px-3 py-1 rounded-full border border-gray-700 text-xs">
                    <span class="w-2 h-2 bg-green-500 rounded-full mr-2 online-indicator"></span>
                    <span id="online-count" class="font-bold text-white mr-1.5 text-sm">1</span>
                    <span class="text-gray-400">Online</span>
                </div>
            </div>
            
            <p class="text-gray-400 text-center text-sm mb-4">
                Lascia un messaggio anonimo o scopri quelli vicini!
            </p>

            <div id="location-message" class="mb-4 text-xs"></div>

            <!-- Blocco Invia Messaggio -->
            <div id="send-block" class="p-3 rounded-xl shadow-inner bg-gray-800 border border-gray-700">
                <textarea id="message-input" class="w-full p-3 mb-2 bg-gray-900 text-white rounded-lg border border-gray-600 focus:ring-green-500 focus:border-green-500 resize-none text-sm" rows="2" placeholder="Attendere acquisizione posizione..." disabled></textarea>
                
                <!-- NUOVO: Griglia Controlli a 3 colonne riordinata con icone piccole -->
                <div class="grid grid-cols-3 gap-2 mb-2">
                    
                    <!-- 1. Controlli Raggio (Sinistra) -->
                    <div class="flex flex-col items-center p-1.5 bg-gray-700/50 rounded-lg border border-gray-600">
                        <div class="flex items-center space-x-1 mb-1">
                            <svg class="w-3 h-3 text-cyan-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg>
                            <span class="text-[9px] text-gray-400 font-bold uppercase tracking-wider">Raggio</span>
                        </div>
                        <select id="message-radius" class="bg-transparent border-none text-white text-xs font-bold focus:ring-0 p-0 text-center w-full" disabled>
                            <option value="100" selected>100m</option>
                            <option value="50">50m</option>
                        </select>
                    </div>

                    <!-- 2. Controlli Ritardo - Apri tra (Centro) -->
                    <div class="flex flex-col items-center p-1.5 bg-gray-700/50 rounded-lg border border-gray-600 shadow-inner">
                        <div class="flex items-center space-x-1 mb-1">
                            <svg class="w-3 h-3 text-green-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                            <span class="text-[9px] text-gray-400 font-bold uppercase tracking-wider">Apri tra</span>
                        </div>
                        <div class="flex items-center justify-center w-full">
                            <input type="number" id="delay-value" min="0" value="0" class="w-8 p-0 text-center bg-transparent border-none text-white text-xs font-bold focus:ring-0" disabled>
                            <select id="delay-unit" class="bg-transparent border-none text-white text-xs font-bold focus:ring-0 p-0 ml-1" disabled>
                                <option value="minutes">m</option>
                                <option value="hours">h</option>
                                <option value="days">g</option>
                            </select>
                        </div>
                    </div>

                    <!-- 3. Controlli TTL - Durata (Destra) -->
                    <div class="flex flex-col items-center p-1.5 bg-gray-700/50 rounded-lg border border-gray-600">
                        <div class="flex items-center space-x-1 mb-1">
                            <svg class="w-3 h-3 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 22h14"/><path d="M5 2h14"/><path d="M17 22v-4.172a2 2 0 0 0-.586-1.414L12 12l-4.414 4.414A2 2 0 0 0 7 17.828V22"/><path d="M7 2v4.172a2 2 0 0 0 .586 1.414L12 12l4.414-4.414A2 2 0 0 0 17 6.172V2"/></svg>
                            <span class="text-[9px] text-gray-400 font-bold uppercase tracking-wider">Durata</span>
                        </div>
                        <select id="ttl-days" class="bg-transparent border-none text-white text-xs font-bold focus:ring-0 p-0 text-center w-full" disabled>
                            <option value="" selected>7 Giorni</option>
                            <option value="0.04167">1 Ora</option>
                            <option value="0.25">6 Ore</option>
                            <option value="1">1 Giorno</option>
                            <option value="3">3 Giorni</option>
                        </select>
                    </div>

                </div>

                <button id="send-button" disabled class="w-full py-2 flex items-center justify-center space-x-2 rounded-lg font-semibold transition bg-gray-600 cursor-not-allowed text-sm">
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                    <span>Imbottiglia</span>
                </button>
            </div>

             <!-- BANNER GOOGLE PLAY (Visibile solo nel web/browser Android) -->
             <div id="android-install-banner" class="hidden mt-4">
                <a href="https://play.google.com/store/apps/details?id=com.mib.localsecrets" target="_blank" class="flex items-center justify-center space-x-2 bg-gray-800 border border-gray-600 p-2 rounded-lg hover:bg-gray-700 transition">
                    <svg class="w-5 h-5 text-gray-300" viewBox="0 0 24 24" fill="currentColor"><path d="M3.609 1.814L13.792 12 3.61 22.186a2.96 2.96 0 0 1-.607-1.745V3.56c0-.66.216-1.272.606-1.746zm11.75 11.62l3.435 3.435-.939.535c-1.332.766-3.05.69-4.22-.19l1.724-3.78zM14.93 11.26l-1.306-2.91 4.67-2.67c1.17-.666 2.888-.742 4.22.025l-7.584 5.555zm-1.76-3.83L3.106 1.258a3.02 3.02 0 0 1 1.76-.566c.866 0 1.67.355 2.254.922l6.05 6.015z"/></svg>
                    <span class="text-xs font-semibold text-gray-300">Scarica l'App Android</span>
                </a>
             </div>
        </div>

        <!-- LISTA MESSAGGI (Layout naturale senza scroll bloccato) -->
        <div class="w-full px-4 sm:px-8 relative">
            <h2 id="bottles-header" class="text-lg font-semibold text-white mb-4 border-b border-gray-700 pb-2 sticky top-0 bg-gray-900 z-10 pt-4 shadow-lg">
                Bottiglie Trovate (0)
            </h2>
            
            <div id="messages-list" class="space-y-4 pb-32">
                <div class="p-5 bg-gray-800 rounded-xl text-center text-gray-400 border border-dashed border-gray-700">
                    <svg class="w-6 h-6 mx-auto mb-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0z"/><circle cx="12" cy="10" r="3"/></svg>
                    Attendi l'acquisizione della posizione...
                </div>
            </div>
        </div>
        
        <!-- NUOVO: BANNER ISTRUZIONI IOS (Safari & Chrome support) -->
        <div id="ios-install-prompt" class="hidden fixed bottom-0 left-0 right-0 bg-gray-900 border-t-2 border-green-500/50 p-5 z-50">
            <div class="flex justify-between items-start mb-3">
                <div class="flex items-center space-x-2">
                    <img src="icon.png?v=2" class="w-10 h-10 rounded-lg shadow-lg border border-gray-700">
                    <div>
                        <h3 class="text-sm font-bold text-white">Installa M.I.B.</h3>
                        <p class="text-[10px] text-gray-400">Web App per iOS</p>
                    </div>
                </div>
                <button onclick="document.getElementById('ios-install-prompt').style.display='none'" class="text-gray-400 hover:text-white p-1">‚úï</button>
            </div>
            
            <p class="text-xs text-gray-300 mb-4 leading-relaxed">
                Per usare l'app a schermo intero e salvare l'accesso:
            </p>
            
            <!-- Istruzioni Safari -->
            <div id="ios-safari-step" class="hidden flex items-center justify-between bg-gray-800 p-3 rounded-lg border border-gray-700">
                <div class="flex items-center space-x-3 text-xs text-gray-200">
                    <span>1. Tocca</span>
                    <span class="safari-share"></span>
                </div>
                <div class="h-4 w-[1px] bg-gray-600"></div>
                <div class="flex items-center space-x-2 text-xs text-gray-200">
                    <span>2. Scegli</span>
                    <span class="font-bold text-white">Aggiungi a Home</span>
                </div>
            </div>

            <!-- Istruzioni Chrome -->
            <div id="ios-chrome-step" class="hidden flex items-center justify-between bg-gray-800 p-3 rounded-lg border border-gray-700">
                <div class="flex items-center space-x-3 text-xs text-gray-200">
                    <span>1. Tocca <span class="chrome-share"></span> in alto a destra</span>
                </div>
                <div class="h-4 w-[1px] bg-gray-600"></div>
                <div class="flex items-center space-x-2 text-xs text-gray-200">
                    <span>2. Scegli</span>
                    <span class="font-bold text-white">Aggiungi a Home</span>
                </div>
            </div>
        </div>
    </div>

    <!-- FIREBASE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, addDoc, serverTimestamp, deleteDoc, doc, setDoc, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const USER_FIREBASE_CONFIG = {
            apiKey: "AIzaSyBOFHJgBCfVN3hT9EHvI9hSaqH7LxL1UYw", 
            authDomain: "mib-app-b93cd.firebaseapp.com",
            projectId: "mib-app-b93cd",
        };
        const USER_APP_ID = "mib-app-b93cd"; 

        const PROXIMITY_RADIUS_METERS = 100; // Valore di fallback
        const PRESENCE_RADIUS_METERS = 500; 
        const PRESENCE_TIMEOUT_MS = 5 * 60 * 1000;
        const GPS_TIMEOUT_MS = 15000;
        const DEFAULT_TTL_DAYS = 7; 
        
        let db = null;
        let userId = null;
        let location = null;
        let isLocating = false;
        let locationError = null;
        let updateInterval = null; 

        // --- Elementi DOM ---
        const locationMessageDiv = document.getElementById('location-message');
        const messagesList = document.getElementById('messages-list');
        const bottlesHeader = document.getElementById('bottles-header');
        const messageInput = document.getElementById('message-input');
        const onlineUsersBadge = document.getElementById('online-users-badge');
        const onlineCountSpan = document.getElementById('online-count');

        const getIcon = (type) => {
             const icons = {
                'map-pin': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0z"/><circle cx="12" cy="10" r="3"/></svg>`,
                'send': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>`,
                'loader': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-spin"><path d="M21 12a9 9 0 0 1-9 9 9 9 0 0 1-9-9 9 9 0 0 1 9-9z"/><path d="M2 12a10 10 0 0 1 10-10"/></svg>`,
                'x-circle': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>`,
                'clock': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`,
                'trash': `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>`
            };
            return icons[type] || '';
        };

        const getDistance = (lat1, lon1, lat2, lon2) => {
            const R = 6371e3;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        };

        const formatTimeRemaining = (ms) => {
            if (ms <= 0) return 'Ora!';
            const totalSec = Math.floor(ms / 1000);
            const d = Math.floor(totalSec / (3600*24));
            const h = Math.floor((totalSec % (3600*24)) / 3600);
            const m = Math.floor((totalSec % 3600) / 60);
            const s = totalSec % 60;
            if (d > 0) return `${d}g ${h}h`;
            if (h > 0) return `${h}h ${m}m`;
            if (m > 0) return `${m}m ${s}s`;
            return `${s}s`;
        };
        
        function updateUIState() {
            const canSend = db && location && messageInput.value.trim() !== '' && !isLocating && userId;
            
            const btn = document.getElementById('send-button');
            btn.disabled = !canSend;
            
            if (canSend) {
                btn.className = "w-full py-2 flex items-center justify-center space-x-2 rounded-lg font-semibold transition bg-green-600 hover:bg-green-700 text-white";
            } else {
                btn.className = "w-full py-2 flex items-center justify-center space-x-2 rounded-lg font-semibold transition bg-gray-600 cursor-not-allowed text-gray-400";
            }

            const fieldsDisabled = !location || isLocating || !userId || !db;
            messageInput.disabled = fieldsDisabled;
            document.getElementById('delay-value').disabled = fieldsDisabled;
            document.getElementById('delay-unit').disabled = fieldsDisabled;
            document.getElementById('ttl-days').disabled = fieldsDisabled;
            document.getElementById('message-radius').disabled = fieldsDisabled;
            
            if (location && !isLocating) {
                messageInput.placeholder = "Scrivi qui il tuo messaggio...";
            } else if (isLocating) {
                 messageInput.placeholder = "Ricerca posizione in corso...";
            } else {
                 messageInput.placeholder = "Attendere acquisizione posizione...";
            }
        }

        function displayLocationMessage() {
            const div = document.getElementById('location-message');
            let html = '';
            if (isLocating) {
                html = `<div class="p-3 bg-blue-600/20 text-blue-300 rounded-lg flex items-center justify-center space-x-2 text-sm">${getIcon('loader')} <span>Ricerca GPS...</span></div>`;
            } else if (locationError) {
                let helpText = "Vai nelle Impostazioni e attiva la posizione, poi ricarica la pagina.";
                if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                    helpText = "Su iPhone: Vai in Impostazioni > Privacy > Localizzazione > Safari (o Chrome). Scegli 'Mentre usi l'app'. Poi clicca Ricarica.";
                }

                html = `<div class="p-3 bg-red-600/20 text-red-300 rounded-lg flex flex-col items-start space-y-2">
                            <div class="flex items-center space-x-2">${getIcon('x-circle')} <span class="font-semibold">Errore GPS</span></div>
                            <p class="text-sm pl-7 leading-snug">${locationError}</p>
                            <p class="text-xs text-gray-400 pl-7 italic">${helpText}</p>
                            <div class="pl-7 flex space-x-2 mt-1">
                                <button onclick="window.location.reload()" class="px-3 py-1.5 bg-red-700 text-white rounded-md hover:bg-red-600 transition text-xs font-semibold shadow-sm shadow-red-900">Ricarica Pagina</button>
                                <button onclick="window.fetchLocation()" class="px-3 py-1.5 border border-red-500 text-red-100 rounded-md hover:bg-red-900/40 transition text-xs">Riprova</button>
                            </div>
                        </div>`;
            } else if (location) {
                html = `<div class="p-2 bg-green-600/20 text-green-300 rounded-lg flex items-center space-x-2 text-sm">${getIcon('map-pin')} <span>Posizione acquisita. Raggio M.I.B. pronto.</span></div>`;
            } else {
                 html = `<div class="p-3 bg-gray-700/50 text-gray-400 rounded-lg flex items-center justify-center space-x-2">${getIcon('loader')} <span>Avvio in corso...</span></div>`;
            }
            div.innerHTML = html;
            updateUIState();
        }

        async function updatePresence() {
            if (!db || !userId || !location) return;
            try {
                await setDoc(doc(db, `artifacts/${USER_APP_ID}/public/data/presence`, userId), {
                    latitude: location.lat, longitude: location.lng, timestamp: serverTimestamp()
                }, { merge: true });
            } catch (e) { console.error("Err Presenza", e); }
        }

        function checkIOSInstall() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            const isStandalone = window.navigator.standalone === true;

            if (isIOS && !isStandalone) {
                const banner = document.getElementById('ios-install-prompt');
                banner.classList.remove('hidden');
                
                // NUOVO: Controllo specifico Safari vs Chrome per le icone
                const isChrome = navigator.userAgent.includes("CriOS");
                if (isChrome) {
                    document.getElementById('ios-chrome-step').classList.remove('hidden');
                } else {
                    document.getElementById('ios-safari-step').classList.remove('hidden');
                }
            } else if (!isIOS) {
                if (window.location.hostname.includes('vercel.app')) {
                    const androidBanner = document.getElementById('android-install-banner');
                    if(androidBanner) androidBanner.classList.remove('hidden');
                }
            }
            
            if (isIOS && isStandalone) {
                const hasCounted = localStorage.getItem('ios_install_counted_v2');
                if (!hasCounted && db) {
                    const statsRef = doc(db, `artifacts/${USER_APP_ID}/public/data/stats`, 'ios_installs');
                    setDoc(statsRef, { count: increment(1) }, { merge: true })
                        .then(() => {
                            localStorage.setItem('ios_install_counted_v2', 'true');
                        })
                        .catch((e) => {});
                }
            }
        }

        function setupPresenceListener() {
            if (!db || !userId) return;
            onSnapshot(query(collection(db, `artifacts/${USER_APP_ID}/public/data/presence`)), (snapshot) => {
                if (!location) return;
                const now = Date.now();
                let onlineCount = 0;
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    if (!data.latitude || !data.timestamp) return;
                    if ((now - data.timestamp.toDate().getTime()) < PRESENCE_TIMEOUT_MS) {
                        if (getDistance(location.lat, location.lng, data.latitude, data.longitude) <= PRESENCE_RADIUS_METERS) onlineCount++;
                    }
                });
                const badge = document.getElementById('online-users-badge');
                if (onlineCount > 0) {
                    badge.classList.remove('hidden');
                    document.getElementById('online-count').textContent = onlineCount;
                } else {
                    badge.classList.add('hidden');
                }
            });
        }

        window.fetchLocation = () => {
            if (!navigator.geolocation) { locationError = "GPS non supportato"; displayLocationMessage(); return; }
            isLocating = true; locationError = null; location = null; displayLocationMessage();
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    location = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    isLocating = false;
                    displayLocationMessage();
                    setupDbListener();
                    updatePresence();
                    setupPresenceListener();
                    setInterval(updatePresence, 60000);
                },
                (err) => {
                    let msg = `Errore GPS (Codice ${err.code}).`;
                    if (err.code === 1) {
                         msg = "Permesso negato. Vai nelle Impostazioni e attiva la posizione, poi clicca Ricarica.";
                    } else if (err.code === 2) {
                         msg = "Segnale debole. Spostati all'aperto o attiva il Wi-Fi.";
                    } else if (err.code === 3) {
                         msg = "Tempo scaduto. Riprova.";
                    }
                    locationError = msg;
                    isLocating = false;
                    displayLocationMessage();
                },
                { enableHighAccuracy: true, timeout: GPS_TIMEOUT_MS, maximumAge: 0 }
            );
        };

        function initFirebaseAndAuth() {
            try {
                const app = initializeApp(USER_FIREBASE_CONFIG);
                db = getFirestore(app);
                const auth = getAuth(app);
                onAuthStateChanged(auth, (user) => {
                    if (user) { userId = user.uid; window.fetchLocation(); checkIOSInstall(); }
                    else { signInAnonymously(auth).then(cred => { userId = cred.user.uid; window.fetchLocation(); checkIOSInstall(); }).catch(e => { locationError="Errore Auth"; displayLocationMessage(); }); }
                });
            } catch (e) { locationError = e.message; displayLocationMessage(); }
        }

        const calculateUnlockTime = () => {
            const delay = parseInt(document.getElementById('delay-value').value);
            const unit = document.getElementById('delay-unit').value;
            let ms = 0;
            if (delay > 0) {
                if (unit === 'minutes') ms = delay * 60000;
                if (unit === 'hours') ms = delay * 3600000;
                if (unit === 'days') ms = delay * 86400000;
            }
            return Date.now() + ms;
        };

        const calculateTTL = () => {
             const daysValue = document.getElementById('ttl-days').value;
             let days = parseFloat(daysValue);
             if (!daysValue || isNaN(days)) {
                 days = DEFAULT_TTL_DAYS; 
             }
             return new Date(Date.now() + (days * 86400000));
        };

        // NUOVO: FUNZIONE STILE (Sfumature morbide, senza buchi visivi)
        const getAgeStyle = (timestamp, isNewest) => {
            const now = new Date();
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            
            const msgDate = new Date(timestamp);
            const msgDayStart = new Date(msgDate.getFullYear(), msgDate.getMonth(), msgDate.getDate()).getTime();
            
            const daysDiff = Math.round((todayStart - msgDayStart) / (1000 * 60 * 60 * 24));

            // 1. L'ULTIMO MESSAGGIO DELLA ZONA
            if (isNewest) {
                if (daysDiff === 0) {
                    return { classes: 'border-green-400 border-2 message-glow bg-gray-800 text-white font-medium', opacity: '1' };
                } else {
                    return { classes: 'border-green-500/80 border bg-gray-800 text-gray-100 font-medium', opacity: '1' };
                }
            }

            // 2. ALTRI MESSAGGI (Degrado pi√π dolce in 5 passi)
            if (daysDiff === 0) { // OGGI
                return { classes: 'border-green-400 border-2 message-glow bg-gray-800 text-white font-medium', opacity: '1' };
            }
            if (daysDiff === 1) { // IERI (Visibile e leggibile, no neon)
                return { classes: 'border-gray-600 border bg-gray-800/90 text-gray-200', opacity: '0.90' };
            }
            if (daysDiff === 2) { // L'ALTRO IERI (Inizia a sbiadire dolcemente)
                return { classes: 'border-gray-700 border bg-gray-800/70 text-gray-300', opacity: '0.80' };
            }
            if (daysDiff > 2 && daysDiff < 5) { // 3-4 GIORNI (Vecchio ma presente)
                return { classes: 'border-transparent bg-gray-800/50 text-gray-400', opacity: '0.65' };
            }
            
            // ANTICO (>= 5 giorni) - Non sparisce mai del tutto. Pavimento di visibilit√† al 50%
            return { classes: 'border-transparent bg-gray-800/30 text-gray-500 italic hover:opacity-100 transition-opacity duration-500', opacity: '0.50' };
        };

        async function handleSendMessage() {
            if (!db || !location || !userId) return;
            const msgTxt = messageInput.value.trim();
            if (!msgTxt) return;

            // Lettura del raggio
            const radiusValue = parseInt(document.getElementById('message-radius').value) || PROXIMITY_RADIUS_METERS;

            try {
                await addDoc(collection(db, `artifacts/${USER_APP_ID}/public/data/bottles`), {
                    userId: userId,
                    message: msgTxt,
                    latitude: location.lat,
                    longitude: location.lng,
                    timestamp: serverTimestamp(),
                    unlockTimestamp: calculateUnlockTime(),
                    expireAt: calculateTTL(),
                    radius: radiusValue // Salviamo il raggio su Firebase
                });
                messageInput.value = '';
                document.getElementById('delay-value').value = 0;
                document.getElementById('ttl-days').value = ''; 
                document.getElementById('message-radius').value = '100';
                updatePresence();
                updateUIState();
            } catch (e) { console.error(e); }
        }

        async function deleteMessage(id) {
            if (!db || !userId || !id) return;
            if (!confirm("Sei sicuro di voler cancellare questo messaggio?")) return;
            try { await deleteDoc(doc(db, `artifacts/${USER_APP_ID}/public/data/bottles`, id)); } 
            catch(e) { alert("Errore cancellazione"); }
        }
        window.deleteMessage = deleteMessage;

        function setupDbListener() {
            const q = query(collection(db, `artifacts/${USER_APP_ID}/public/data/bottles`));
            if (window.mibIntervalId) clearInterval(window.mibIntervalId);
            window.mibIntervalId = setInterval(updateDisplay, 1000);

            function updateDisplay() {
                if (!messagesList.messages || !location) return;
                const now = Date.now();
                
                // Filtro con raggio dinamico specifico per ogni messaggio
                const visible = messagesList.messages.filter(msg => {
                    const radius = msg.radius || PROXIMITY_RADIUS_METERS;
                    const dist = getDistance(location.lat, location.lng, msg.latitude, msg.longitude);
                    return dist <= radius;
                }).sort((a,b) => b.timestamp - a.timestamp);
                
                messagesList.innerHTML = '';
                bottlesHeader.textContent = `Bottiglie Trovate (${visible.filter(m => m.unlockTimestamp <= now).length})`;
                
                if (visible.length === 0) {
                    messagesList.innerHTML = `<div class="p-5 bg-gray-800 rounded-xl text-center text-gray-400 border border-dashed border-gray-700">Nessuna bottiglia qui.</div>`;
                    return;
                }

                visible.forEach((msg, index) => {
                    const isUnlocked = msg.unlockTimestamp <= now;
                    const isOwner = msg.userId === userId;
                    const dateStr = new Date(msg.timestamp).toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                    
                    // Badge raggio visualizzato vicino alla data
                    const radiusBadge = `<span class="bg-gray-700/50 px-1.5 py-0.5 rounded text-[9px] ml-1">üìç ${msg.radius || 100}m</span>`;
                    
                    const delBtn = isOwner ? `<button onclick="window.deleteMessage('${msg.id}')" class="absolute top-3 right-3 p-1 text-gray-500 hover:text-red-500 z-10">${getIcon('trash')}</button>` : '';
                    
                    const isNewest = (index === 0);
                    const ageStyle = getAgeStyle(msg.timestamp, isNewest);

                    let html = isUnlocked ? 
                        `${delBtn}<p class="text-xs mb-2 italic pr-8 ${ageStyle.classes.includes('text-gray-500') ? 'text-gray-500' : 'text-gray-300'} opacity-80">Da <span class="font-mono text-xs text-yellow-400">${isOwner?'Te':'Anonimo'}</span> il ${dateStr} ${radiusBadge}</p><div class="border-l-4 pl-3 pr-2 border-green-500/50"><p class="text-lg break-words">${msg.message}</p></div>` :
                        `${delBtn}<div class="pr-8"><p class="text-sm font-semibold text-red-400 flex items-center space-x-2">${getIcon('clock')} APERTURA TRA: <span class="text-lg font-bold text-red-300 ml-1">${formatTimeRemaining(msg.unlockTimestamp - now)}</span></p></div>`;
                    
                    const div = document.createElement('div');
                    
                    // Applicazione stile dinamico
                    div.className = `p-4 rounded-xl shadow-lg relative transition transform hover:scale-[1.01] ${!isUnlocked ? 'bg-red-900/40 border border-red-700' : ageStyle.classes}`;
                    div.style.opacity = !isUnlocked ? '1' : ageStyle.opacity;
                    div.innerHTML = html;
                    
                    messagesList.appendChild(div);
                });
            }

            onSnapshot(q, (snapshot) => {
                messagesList.messages = snapshot.docs.map(d => ({id: d.id, ...d.data(), timestamp: d.data().timestamp?.toDate().getTime(), expireAt: d.data().expireAt?.toDate().getTime(), unlockTimestamp: d.data().unlockTimestamp || 0}));
                updateDisplay();
            });
        }

        window.onload = function() {
            initFirebaseAndAuth();
            document.getElementById('send-button').addEventListener('click', handleSendMessage);
            document.getElementById('message-input').addEventListener('input', updateUIState);
            document.getElementById('delay-value').addEventListener('input', updateUIState);
            document.getElementById('delay-unit').addEventListener('change', updateUIState);
            document.getElementById('ttl-days').addEventListener('change', updateUIState);
            document.getElementById('message-radius').addEventListener('change', updateUIState);
            updateUIState();
        };
    </script>
</body>
</html>
