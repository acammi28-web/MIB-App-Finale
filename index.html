
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M.I.B. (Message In a Bottle) - App Finale</title>
    <!-- Tailwind CSS CDN per lo styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        .icon { width: 24px; height: 24px; display: inline-block; vertical-align: middle; }
    </style>
</head>
<body class="bg-gray-900 min-h-screen flex flex-col items-center p-4 sm:p-8">

    <div id="app" class="w-full max-w-lg">
        <!-- TITOLO M.I.B. -->
        <h1 class="text-3xl font-bold text-center text-green-500 mb-6 flex items-center justify-center space-x-2 tracking-widest">
            <svg class="w-7 h-7 text-green-500 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
            <span>M.I.B.</span>
        </h1>
        
        <p class="text-gray-400 text-center mb-6">
            Lascia un messaggio anonimo o scopri quelli lasciati nelle vicinanze!
        </p>

        <!-- Contenitore per Messaggio Posizione -->
        <div id="location-message" class="mb-6">
            <!-- Inizializzato da JS -->
        </div>

        <!-- Blocco Invia Messaggio -->
        <div id="send-block" class="p-5 rounded-xl shadow-2xl transition-all bg-gray-800">
            <textarea id="message-input" class="w-full p-3 mb-4 bg-gray-700 text-white rounded-lg border border-gray-600 focus:ring-green-500 focus:border-green-500 resize-none" rows="3" placeholder="Attendere l'acquisizione della posizione..." disabled></textarea>
            
            <!-- Controlli Ritardo (Capsula del Tempo) -->
            <div class="flex items-center space-x-3 mb-4 p-3 bg-gray-700/50 rounded-lg border border-gray-600">
                <svg class="w-5 h-5 text-green-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                <label class="text-gray-300 text-sm flex-shrink-0">Apri tra:</label>
                <input type="number" id="delay-value" min="0" value="0" class="w-16 p-1 text-center bg-gray-800 border-none rounded text-white" disabled>
                <select id="delay-unit" class="p-1 bg-gray-800 border-none rounded text-white" disabled>
                    <option value="minutes">Minuti</option>
                    <option value="hours">Ore</option>
                    <option value="days">Giorni</option>
                </select>
            </div>

            <button id="send-button" disabled class="mt-1 w-full py-2 flex items-center justify-center space-x-2 rounded-lg font-semibold transition bg-gray-600 cursor-not-allowed">
                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                <span>Imbottiglia il Messaggio</span>
            </button>
        </div>

        <!-- Blocco Messaggi Trovati -->
        <div class="mt-8">
            <h2 id="bottles-header" class="text-2xl font-semibold text-white mb-4 border-b border-gray-700 pb-2">
                Bottiglie Trovate (0)
            </h2>
            
            <div id="messages-list" class="space-y-4">
                <div class="p-5 bg-gray-800 rounded-xl text-center text-gray-400 border border-dashed border-gray-700">
                    <svg class="w-6 h-6 mx-auto mb-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0z"/><circle cx="12" cy="10" r="3"/></svg>
                    Attendi l'acquisizione della posizione per visualizzare le bottiglie.
                </div>
            </div>
        </div>
    </div>

    <!-- Importazioni Firebase - Versione completa (Modulo JavaScript) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // =================================================================
        // *** üõë INFORMAZIONI DI CONFIGURAZIONE CRITICHE üõë ***
        // QUESTE DEVONO ESSERE FORNITE DAL TUO PROGETTO FIREBASE PERSONALE
        // =================================================================
        const USER_FIREBASE_CONFIG = {
            apiKey: "AIzaSyBOFHJgBCfVN3hT9EHvI9hSaqH7LxL1UYw", // CHIAVE INCOLLATA
            authDomain: "mib-app-b93cd.firebaseapp.com", // DOMAIN INCOLLATO
            projectId: "mib-app-b93cd", // ID INCOLLATO
        };
        const USER_APP_ID = "mib-app-b93cd"; // HO UNIFORMATO QUESTA VARIABILE AL TUO PROJECT ID
        // =================================================================


        // --- Costanti e Stato ---
        const PROXIMITY_RADIUS_METERS = 100;
        const GPS_TIMEOUT_MS = 15000;
        const TTL_DAYS = 7; // NUOVA COSTANTE: Durata di vita del messaggio in giorni
        
        let db = null;
        let userId = null;
        let location = null;
        let isLocating = false;
        let locationError = null;
        let updateInterval = null; // Gestore del countdown globale

        // --- Elementi DOM ---
        const locationMessageDiv = document.getElementById('location-message');
        const messagesList = document.getElementById('messages-list');
        const bottlesHeader = document.getElementById('bottles-header');
        const messageInput = document.getElementById('message-input');


        // --- Funzioni di Utilit√† e Icone ---
        
        const getIcon = (type) => {
             const icons = {
                'map-pin': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0z"/><circle cx="12" cy="10" r="3"/></svg>`,
                'send': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>`,
                'loader': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-spin"><path d="M21 12a9 9 0 0 1-9 9 9 9 0 0 1-9-9 9 9 0 0 1 9-9z"/><path d="M2 12a10 10 0 0 1 10-10"/></svg>`,
                'x-circle': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>`,
                'clock': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`
            };
            return icons[type] || '';
        };

        const getDistance = (lat1, lon1, lat2, lon2) => {
            const R = 6371e3;
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c;
        };

        const formatTimeRemaining = (ms) => {
            if (ms <= 0) return 'Ora!';
            const totalSeconds = Math.floor(ms / 1000);
            const totalMinutes = Math.floor(totalSeconds / 60);
            const totalHours = Math.floor(totalMinutes / 60);

            const seconds = totalSeconds % 60;
            const minutes = totalMinutes % 60;
            const hours = totalHours;

            if (hours > 0) return `${hours} ore e ${minutes} min`;
            if (minutes > 0) return `${minutes} min e ${seconds} sec`;
            return `${seconds} secondi`;
        };
        
        // --- Gestione Stato UI (DOM) ---
        
        function updateUIState() {
            const messageInput = document.getElementById('message-input');
            const delayValueInput = document.getElementById('delay-value');
            const delayUnitSelect = document.getElementById('delay-unit');
            const sendButton = document.getElementById('send-button');
            
            const isConfigMissing = USER_FIREBASE_CONFIG.apiKey.includes('INSERISCI');
            
            // Pu√≤ inviare solo se DB √® attivo E la posizione √® disponibile
            const canSend = !isConfigMissing && db && location && messageInput.value.trim() !== '' && !isLocating && userId;
            sendButton.disabled = !canSend;
            
            sendButton.classList.toggle('bg-green-600', canSend);
            sendButton.classList.toggle('hover:bg-green-700', canSend);
            sendButton.classList.toggle('bg-gray-600', !canSend);
            sendButton.classList.toggle('cursor-not-allowed', !canSend);
            
            const fieldsDisabled = !location || isLocating || !userId || !db || isConfigMissing;
            messageInput.disabled = fieldsDisabled;
            delayValueInput.disabled = fieldsDisabled;
            delayUnitSelect.disabled = fieldsDisabled;
            
            // Aggiorna il placeholder del campo di input
            if (location && !isLocating) {
                messageInput.placeholder = "Scrivi qui il tuo messaggio da imbottigliare...";
            } else if (isLocating) {
                 messageInput.placeholder = "Ricerca posizione in corso...";
            } else {
                 messageInput.placeholder = "Attendendo l'acquisizione della posizione...";
            }
        }

        function displayLocationMessage() {
            const div = document.getElementById('location-message');
            let html = '';
            const isConfigMissing = USER_FIREBASE_CONFIG.apiKey.includes('INSERISCI');

            if (isConfigMissing) {
                 html = `<div class="p-3 bg-red-600/20 text-red-300 rounded-lg flex items-center space-x-2 text-sm">
                            ${getIcon('x-circle')} <span class="font-bold">ERRORE FATALE:</span> Inserisci la configurazione Firebase nel codice!
                        </div>`;
            } else if (isLocating) {
                html = `<div class="p-3 bg-blue-600/20 text-blue-300 rounded-lg flex items-center justify-center space-x-2 text-sm">
                            ${getIcon('loader')} <span>Ricerca della posizione in corso (Max ${GPS_TIMEOUT_MS/1000}s)...</span>
                        </div>`;
            } else if (locationError) {
                html = `<div class="p-3 bg-red-600/20 text-red-300 rounded-lg flex flex-col items-start space-y-1">
                            <div class="flex items-center space-x-2">
                                ${getIcon('x-circle')} <span class="font-semibold">ERRORE CRITICO GPS:</span>
                            </div>
                            <p class="text-sm pl-7 break-words">${locationError}</p>
                            <button onclick="window.fetchLocation()" class="ml-7 mt-2 px-3 py-1 bg-red-800 rounded-md hover:bg-red-700 transition text-sm">
                                Riprova
                            </button>
                            <p class="text-xs mt-2 pl-7 text-red-400/80">
                                Codice errore: ${locationError.match(/Codice: (\d)/)?.[1] || 'Sconosciuto'}.
                                ${locationError.match(/Codice: 1/)? 'Se il codice √® 1 (Permesso Negato), devi sbloccare il GPS nelle impostazioni del browser/dispositivo.' : ''}
                            </p>
                        </div>`;
            } else if (location) {
                html = `<div class="p-2 bg-green-600/20 text-green-300 rounded-lg flex items-center space-x-2 text-sm">
                            ${getIcon('map-pin')} <span>Posizione acquisita. Raggio: ${PROXIMITY_RADIUS_METERS}m</span>
                        </div>`;
            } else {
                 html = `<div class="p-3 bg-gray-700/50 text-gray-400 rounded-lg flex items-center justify-center space-x-2">
                            ${getIcon('loader')} <span>Attendendo l'avvio dell'applicazione...</span>
                        </div>`;
            }
            div.innerHTML = html;
            updateUIState();
        }

        // Funzione per l'avvio della ricerca GPS
        window.fetchLocation = () => {
            if (!navigator.geolocation) {
                locationError = "La Geolocation non √® supportata dal tuo browser.";
                displayLocationMessage();
                return;
            }
            
            isLocating = true;
            locationError = null;
            location = null;
            displayLocationMessage();

            const success = (position) => {
                location = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                };
                isLocating = false;
                displayLocationMessage();
                // ** Chiamata aggiuntiva per forzare la lettura dopo il GPS **
                setupDbListener();
            };

            const error = (err) => {
                let errorMsg = `Errore Geolocation (Codice: ${err.code}): `;
                switch (err.code) {
                    case 1: errorMsg += 'Permesso Negato dall\'utente/browser.'; break;
                    case 2: errorMsg += 'Posizione non disponibile (segnale GPS debole).'; break;
                    case 3: errorMsg += 'Timeout scaduto (Ricerca troppo lenta).'; break;
                    default: errorMsg += 'Errore Sconosciuto.';
                }
                locationError = errorMsg;
                isLocating = false;
                displayLocationMessage();
            };

            navigator.geolocation.getCurrentPosition(success, error, {
                enableHighAccuracy: true,
                timeout: GPS_TIMEOUT_MS,
                maximumAge: 0
            });
        };
        
        // --- Logica Firebase ---

        function initFirebaseAndAuth() {
            const isConfigMissing = USER_FIREBASE_CONFIG.apiKey.includes('INSERISCI');

            if (isConfigMissing) {
                displayLocationMessage(); // Mostra l'errore di configurazione Firebase
                return; 
            }

            try {
                const app = initializeApp(USER_FIREBASE_CONFIG);
                db = getFirestore(app);
                const userAuth = getAuth(app);
                
                // LA PARTE CRITICA: Avviare tutto SOLO dopo l'autenticazione
                onAuthStateChanged(userAuth, (user) => {
                    if (user) {
                        userId = user.uid;
                        // Se l'utente √® gi√† connesso, avvia subito il GPS
                        window.fetchLocation(); 
                    } else {
                        // Se l'utente non √® connesso, prova ad accedere in modo anonimo
                        signInAnonymously(userAuth).then(cred => {
                            userId = cred.user.uid;
                            // ** Avvia il GPS e il Listener DB solo qui, dopo l'autenticazione anonima **
                            window.fetchLocation();
                        })
                           .catch(e => {
                                // Se anche l'anonimo fallisce (es. Authentication non abilitata), blocca l'app
                                locationError = `Errore Auth: Abilita il metodo 'Anonimo' in Firebase.`;
                                displayLocationMessage();
                                return;
                            });
                    }
                    
                });
            } catch (error) {
                locationError = `Errore inizializzazione Firebase: Controlla le tue chiavi di configurazione. Messaggio: ${error.message}`;
                displayLocationMessage();
            }
        }
        
        // Funzione per calcolare l'Unlock Time
        const calculateUnlockTime = () => {
            const delay = parseInt(document.getElementById('delay-value').value);
            const unit = document.getElementById('delay-unit').value;
            
            let unlockTime = Date.now();
            if (delay > 0) {
                let multiplier = 0;
                if (unit === 'minutes') {
                    multiplier = 60 * 1000;
                } else if (unit === 'hours') {
                    multiplier = 60 * 60 * 1000; 
                } else if (unit === 'days') {
                    multiplier = 24 * 60 * 60 * 1000;
                }
                unlockTime += delay * multiplier;
            }
            return unlockTime;
        }

        // Invio del Messaggio (Imbottigliamento)
        async function handleSendMessage() {
            if (!db || !location || !userId) {
                console.error("Impossibile inviare: Database non connesso o posizione mancante.");
                return;
            }

            try {
                const messageInput = document.getElementById('message-input');
                const message = messageInput.value.trim();
                
                const unlockTimestamp = calculateUnlockTime();
                
                // --- LOGICA TTL (Scadenza Automatica Dopo 7 Giorni) ---
                // Il campo deve essere un Timestamp di Firestore per la funzione TTL.
                // Usiamo una data futura calcolata a 7 giorni
                const expirationDate = new Date(Date.now() + (TTL_DAYS * 24 * 60 * 60 * 1000));
                
                const bottlesCollectionRef = collection(db, `artifacts/${USER_APP_ID}/public/data/bottles`);
                await addDoc(bottlesCollectionRef, {
                    userId: userId, 
                    message: message,
                    latitude: location.lat,
                    longitude: location.lng,
                    timestamp: serverTimestamp(),
                    unlockTimestamp: unlockTimestamp, 
                    expireAt: expirationDate, // NUOVO CAMPO: Usato da Firestore TTL per l'eliminazione automatica
                });

                messageInput.value = '';
                document.getElementById('delay-value').value = 0; 
                document.getElementById('delay-unit').value = 'minutes';
                updateUIState();
            } catch (e) {
                console.error("Errore nell'invio del messaggio: ", e);
            }
        }

        // Lettura dei Messaggi Nelle Vicinanze
        function setupDbListener() {
            if (!db || !userId) return;

            const bottlesCollectionRef = collection(db, `artifacts/${USER_APP_ID}/public/data/bottles`);
            const q = query(bottlesCollectionRef); 
            
            // Ferma e riavvia il timer del countdown
            if (window.mibIntervalId) {
                clearInterval(window.mibIntervalId);
            }
            window.mibIntervalId = setInterval(updateMessageDisplay, 1000); 

            // Questa funzione filtra e aggiorna la UI
            function updateMessageDisplay() {
                if (!messagesList.messages || !location) return; 
                
                const now = Date.now();
                const messagesToDisplay = messagesList.messages.filter(msg => {
                    if (!msg.latitude || !msg.longitude) return false;
                    
                    const distance = getDistance(location.lat, location.lng, msg.latitude, msg.longitude); 
                    const isNearby = distance <= PROXIMITY_RADIUS_METERS;

                    return isNearby; 
                });
                
                messagesToDisplay.sort((a, b) => b.timestamp - a.timestamp);
                
                renderMessages(messagesToDisplay);
            }

            // Funzione di rendering principale (disegna l'HTML)
            function renderMessages(messages) {
                messagesList.innerHTML = '';
                
                // Contiamo solo i messaggi sbloccati per l'intestazione
                bottlesHeader.textContent = `Bottiglie Trovate (${messages.filter(msg => !msg.unlockTimestamp || msg.unlockTimestamp <= Date.now()).length})`;

                if (messages.length === 0) {
                    messagesList.innerHTML = `
                        <div class="p-5 bg-gray-800 rounded-xl text-center text-gray-400 border border-dashed border-gray-700">
                             Nessuna bottiglia trovata entro ${PROXIMITY_RADIUS_METERS} metri.
                        </div>`;
                    return;
                }
                
                messages.forEach(msg => {
                    const now = Date.now();
                    const isUnlocked = !msg.unlockTimestamp || msg.unlockTimestamp <= now;
                    const remainingTimeMs = msg.unlockTimestamp - now;
                    const unlockTimeDate = new Date(msg.unlockTimestamp);
                    
                    const formattedDate = new Date(msg.timestamp).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
                    
                    let contentHTML;
                    let cardClasses;
                    
                    if (isUnlocked) {
                        contentHTML = `
                            <p class="text-gray-300 text-sm mb-2 italic">
                                Lasciato da <span class="font-mono text-xs text-yellow-400">Anonimo</span> alle ${formattedDate}
                            </p>
                            <div class="border-l-4 border-green-500 pl-3">
                                <p class="text-white text-lg break-words">${msg.message}</p>
                            </div>
                        `;
                        cardClasses = "bg-gray-800 border-gray-700/50 hover:border-green-500";
                    } else {
                        // CAPSULA DEL TEMPO BLOCCO
                        contentHTML = `
                            <p class="text-sm font-semibold text-red-400 flex items-center space-x-2">
                                ${getIcon('clock')} CAPSULA DEL TEMPO - Apertura tra: <span class="text-lg font-bold text-red-300 ml-1">${formatTimeRemaining(remainingTimeMs)}</span>
                            </p>
                            <p class="text-gray-400 mt-1 text-xs">
                                Ora di sblocco: ${unlockTimeDate.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit', second: '2-digit' })}.
                            </p>
                        `;
                        cardClasses = "bg-red-900/40 border-red-700";
                    }

                    const div = document.createElement('div');
                    div.className = `p-4 rounded-xl shadow-lg border transition transform hover:scale-[1.01] ${cardClasses}`;
                    div.innerHTML = contentHTML;
                    messagesList.appendChild(div);
                });
            }


            // Listener Firestore (Recupera TUTTI i messaggi e li salva in memoria)
            const unsubscribe = onSnapshot(q, (snapshot) => {
                // Manteniamo i messaggi in una variabile temporanea per il filtro
                messagesList.messages = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    // Convertiamo il timestamp di Firebase in millisecondi JS
                    timestamp: doc.data().timestamp?.toDate().getTime(),
                    // Assicuriamo che unlockTimestamp sia un numero, anche se manca
                    unlockTimestamp: doc.data().unlockTimestamp || 0,
                    // TTL - Campo expireAt
                    expireAt: doc.data().expireAt?.toDate().getTime(), 
                }));
                // Aggiorna la visualizzazione immediatamente
                updateMessageDisplay(); 
            }, (error) => {
                console.error("Errore di lettura in tempo reale:", error);
                // Non mostrare messaggi inviati con rules = false;
                messagesList.innerHTML = `<div class="p-5 bg-red-800/50 rounded-xl text-center text-red-300">Errore nel caricamento: Controlla le Regole di Sicurezza di Firestore.</div>`;
            });

            // Cleanup
            return () => {
                clearInterval(window.mibIntervalId);
                unsubscribe();
            };
        }


        // --- Avvio e Event Listeners ---

        window.onload = function() {
            // 1. Inizializza Firebase e Autenticazione (che a sua volta avvia il GPS)
            initFirebaseAndAuth();

            // 2. Event Listeners
            document.getElementById('send-button').addEventListener('click', handleSendMessage);
            document.getElementById('message-input').addEventListener('input', updateUIState);
            document.getElementById('delay-value').addEventListener('input', updateUIState);
            document.getElementById('delay-unit').addEventListener('change', updateUIState);
            
            // Aggiorna lo stato iniziale
            updateUIState();
        };
    </script>
</body>
</html>
