<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>M.I.B. (Message In a Bottle) - App Finale</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        .icon { width: 24px; height: 24px; display: inline-block; vertical-align: middle; }
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(74, 222, 128, 0); }
            100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); }
        }
        .online-indicator { animation: pulse-green 2s infinite; }
        
        /* Rimosso overflow:hidden per permettere lo scroll naturale di tutta la pagina */
        body { 
            background-color: #111827; /* bg-gray-900 */
            min-height: 100vh;
        }
    </style>
</head>
<body class="text-white">

    <div id="app" class="w-full max-w-lg mx-auto relative pb-10">
        
        <!-- PARTE SUPERIORE (Scorre via quando leggi i messaggi) -->
        <div class="p-4 sm:p-8 pb-2">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-3xl font-bold text-center text-green-500 flex items-center tracking-widest">
                    <svg class="w-7 h-7 text-green-500 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                    <span>M.I.B.</span>
                </h1>
                
                <!-- Indicatore Utenti Online -->
                <div id="online-users-badge" class="hidden flex items-center bg-gray-800 px-3 py-1 rounded-full border border-gray-700 text-xs">
                    <span class="w-2 h-2 bg-green-500 rounded-full mr-2 online-indicator"></span>
                    <span id="online-count" class="font-bold text-white mr-1.5 text-sm">1</span>
                    <span class="text-gray-400">Online</span>
                </div>
            </div>
            
            <p class="text-gray-400 text-center text-sm mb-4">
                Lascia un messaggio anonimo o scopri quelli vicini!
            </p>

            <div id="location-message" class="mb-4 text-xs"></div>

            <!-- Blocco Invia Messaggio -->
            <div id="send-block" class="p-3 rounded-xl shadow-inner bg-gray-800 border border-gray-700">
                <textarea id="message-input" class="w-full p-3 mb-2 bg-gray-900 text-white rounded-lg border border-gray-600 focus:ring-green-500 focus:border-green-500 resize-none text-sm" rows="2" placeholder="Attendere acquisizione posizione..." disabled></textarea>
                
                <div class="flex justify-between gap-2 mb-2">
                    <!-- Controlli Ritardo -->
                    <div class="flex items-center space-x-1 p-1.5 bg-gray-700/50 rounded-lg border border-gray-600 flex-1 justify-center">
                        <svg class="w-3 h-3 text-green-400 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                        <span class="text-[10px] text-gray-300 leading-none whitespace-nowrap">Apri tra</span>
                        <select id="delay-unit" class="bg-transparent border-none text-white text-xs focus:ring-0 p-0">
                            <option value="minutes">Minuti</option>
                            <option value="hours">Ore</option>
                            <option value="days">GG</option>
                        </select>
                        <input type="number" id="delay-value" min="0" value="0" class="w-6 p-0 text-center bg-transparent border-none text-white text-xs focus:ring-0" disabled>
                    </div>
                    
                    <!-- Controlli TTL (Durata) -->
                    <div class="flex items-center space-x-1 p-1.5 bg-gray-700/50 rounded-lg border border-gray-600 flex-1 justify-center">
                        <svg class="w-3 h-3 text-yellow-400 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/><line x1="12" y1="6" x2="12" y2="10"/><line x1="12" y1="14" x2="12" y2="14"/></svg>
                        <span class="text-[10px] text-gray-300 leading-none whitespace-nowrap">Durata</span>
                        <select id="ttl-days" class="bg-transparent border-none text-white text-xs focus:ring-0 p-0 w-full" disabled>
                            <option value="" selected>Seleziona</option>
                            <option value="0.02083">30 Minuti</option>
                            <option value="0.03125">45 Minuti</option>
                            <option value="0.04167">1 Ora</option>
                            <option value="0.25">6 Ore</option>
                            <option value="1">1 Giorno</option>
                            <option value="3">3 Giorni</option>
                            <option value="7">7 Giorni</option>
                        </select>
                    </div>
                </div>

                <button id="send-button" disabled class="w-full py-2 flex items-center justify-center space-x-2 rounded-lg font-semibold transition bg-gray-600 cursor-not-allowed text-sm">
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                    <span>Imbottiglia</span>
                </button>
            </div>
        </div>

        <!-- LISTA MESSAGGI (SCORREVOLE) -->
        <!-- px-4 sm:px-8 per i margini laterali -->
        <div class="w-full px-4 sm:px-8">
            <!-- Header Sticky: Rimane in alto quando scorri la lista dei messaggi -->
            <h2 id="bottles-header" class="text-lg font-semibold text-white mb-4 border-b border-gray-700 pb-2 sticky top-0 bg-gray-900 z-10 pt-4 shadow-lg">
                Bottiglie Trovate (0)
            </h2>
            
            <!-- Padding bottom GIGANTE (pb-64) sul contenitore dei messaggi. 
                 Questo assicura che l'ultimo messaggio abbia circa 250px di spazio vuoto sotto di sé,
                 rendendolo facilissimo da leggere e cliccare. -->
            <div id="messages-list" class="space-y-4 pb-64">
                <div class="p-5 bg-gray-800 rounded-xl text-center text-gray-400 border border-dashed border-gray-700">
                    <svg class="w-6 h-6 mx-auto mb-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0z"/><circle cx="12" cy="10" r="3"/></svg>
                    Attendi l'acquisizione della posizione...
                </div>
            </div>
        </div>
    </div>

    <!-- FIREBASE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, addDoc, serverTimestamp, deleteDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const USER_FIREBASE_CONFIG = {
            apiKey: "AIzaSyBOFHJgBCfVN3hT9EHvI9hSaqH7LxL1UYw", 
            authDomain: "mib-app-b93cd.firebaseapp.com",
            projectId: "mib-app-b93cd",
        };
        const USER_APP_ID = "mib-app-b93cd"; 

        const PROXIMITY_RADIUS_METERS = 100;
        const PRESENCE_RADIUS_METERS = 500; 
        const PRESENCE_TIMEOUT_MS = 5 * 60 * 1000;
        const GPS_TIMEOUT_MS = 15000;
        const DEFAULT_TTL_DAYS = 7; // Durata predefinita se non selezionata
        
        let db = null;
        let userId = null;
        let location = null;
        let isLocating = false;
        let locationError = null;

        const getIcon = (type) => {
             const icons = {
                'map-pin': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0z"/><circle cx="12" cy="10" r="3"/></svg>`,
                'send': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>`,
                'loader': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-spin"><path d="M21 12a9 9 0 0 1-9 9 9 9 0 0 1-9-9 9 9 0 0 1 9-9z"/><path d="M2 12a10 10 0 0 1 10-10"/></svg>`,
                'x-circle': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>`,
                'clock': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`,
                'trash': `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>`
            };
            return icons[type] || '';
        };

        const getDistance = (lat1, lon1, lat2, lon2) => {
            const R = 6371e3;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        };

        const formatTimeRemaining = (ms) => {
            if (ms <= 0) return 'Ora!';
            const totalSec = Math.floor(ms / 1000);
            const d = Math.floor(totalSec / (3600*24));
            const h = Math.floor((totalSec % (3600*24)) / 3600);
            const m = Math.floor((totalSec % 3600) / 60);
            const s = totalSec % 60;
            if (d > 0) return `${d}g ${h}h`;
            if (h > 0) return `${h}h ${m}m`;
            if (m > 0) return `${m}m ${s}s`;
            return `${s}s`;
        };
        
        function updateUIState() {
            const canSend = db && location && messageInput.value.trim() !== '' && !isLocating && userId;
            document.getElementById('send-button').disabled = !canSend;
            
            const btn = document.getElementById('send-button');
            btn.className = `w-full py-2 flex items-center justify-center space-x-2 rounded-lg font-semibold transition ${canSend ? 'bg-green-600 hover:bg-green-700 text-white' : 'bg-gray-600 cursor-not-allowed text-gray-400'}`;

            const fieldsDisabled = !location || isLocating || !userId || !db;
            messageInput.disabled = document.getElementById('delay-value').disabled = document.getElementById('delay-unit').disabled = document.getElementById('ttl-days').disabled = fieldsDisabled;
            
            if (location && !isLocating) {
                messageInput.placeholder = "Scrivi qui il tuo messaggio...";
            } else if (isLocating) {
                 messageInput.placeholder = "Ricerca posizione in corso...";
            } else {
                 messageInput.placeholder = "Attendere acquisizione posizione...";
            }
        }

        function displayLocationMessage() {
            const div = document.getElementById('location-message');
            let html = '';
            if (isLocating) {
                html = `<div class="p-3 bg-blue-600/20 text-blue-300 rounded-lg flex items-center justify-center space-x-2 text-sm">${getIcon('loader')} <span>Ricerca GPS...</span></div>`;
            } else if (locationError) {
                html = `<div class="p-3 bg-red-600/20 text-red-300 rounded-lg flex flex-col items-start space-y-1"><div class="flex items-center space-x-2">${getIcon('x-circle')} <span class="font-semibold">Errore GPS</span></div><p class="text-sm pl-7">${locationError}</p><button onclick="window.fetchLocation()" class="ml-7 mt-2 px-3 py-1 bg-red-800 rounded-md hover:bg-red-700 transition text-sm">Riprova</button></div>`;
            } else if (location) {
                html = `<div class="p-2 bg-green-600/20 text-green-300 rounded-lg flex items-center space-x-2 text-sm">${getIcon('map-pin')} <span>Posizione acquisita. Raggio: ${PROXIMITY_RADIUS_METERS}m</span></div>`;
            } else {
                 html = `<div class="p-3 bg-gray-700/50 text-gray-400 rounded-lg flex items-center justify-center space-x-2">${getIcon('loader')} <span>Avvio in corso...</span></div>`;
            }
            div.innerHTML = html;
            updateUIState();
        }

        async function updatePresence() {
            if (!db || !userId || !location) return;
            try {
                await setDoc(doc(db, `artifacts/${USER_APP_ID}/public/data/presence`, userId), {
                    latitude: location.lat, longitude: location.lng, timestamp: serverTimestamp()
                }, { merge: true });
            } catch (e) { console.error("Err Presenza", e); }
        }

        function setupPresenceListener() {
            if (!db || !userId) return;
            onSnapshot(query(collection(db, `artifacts/${USER_APP_ID}/public/data/presence`)), (snapshot) => {
                if (!location) return;
                const now = Date.now();
                let onlineCount = 0;
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    if (!data.latitude || !data.timestamp) return;
                    if ((now - data.timestamp.toDate().getTime()) < PRESENCE_TIMEOUT_MS) {
                        if (getDistance(location.lat, location.lng, data.latitude, data.longitude) <= PRESENCE_RADIUS_METERS) onlineCount++;
                    }
                });
                const badge = document.getElementById('online-users-badge');
                if (onlineCount > 0) {
                    badge.classList.remove('hidden');
                    document.getElementById('online-count').textContent = onlineCount;
                } else {
                    badge.classList.add('hidden');
                }
            });
        }

        window.fetchLocation = () => {
            if (!navigator.geolocation) { locationError = "GPS non supportato"; displayLocationMessage(); return; }
            isLocating = true; locationError = null; location = null; displayLocationMessage();
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    location = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    isLocating = false;
                    displayLocationMessage();
                    setupDbListener();
                    updatePresence();
                    setupPresenceListener();
                    setInterval(updatePresence, 60000);
                },
                (err) => {
                    locationError = `Errore GPS (Codice ${err.code}). Controlla i permessi.`;
                    isLocating = false;
                    displayLocationMessage();
                },
                { enableHighAccuracy: true, timeout: GPS_TIMEOUT_MS, maximumAge: 0 }
            );
        };

        function initFirebaseAndAuth() {
            try {
                const app = initializeApp(USER_FIREBASE_CONFIG);
                db = getFirestore(app);
                const auth = getAuth(app);
                onAuthStateChanged(auth, (user) => {
                    if (user) { userId = user.uid; window.fetchLocation(); }
                    else { signInAnonymously(auth).then(cred => { userId = cred.user.uid; window.fetchLocation(); }).catch(e => { locationError="Errore Auth"; displayLocationMessage(); }); }
                });
            } catch (e) { locationError = e.message; displayLocationMessage(); }
        }

        const calculateUnlockTime = () => {
            const delay = parseInt(document.getElementById('delay-value').value);
            const unit = document.getElementById('delay-unit').value;
            let ms = 0;
            if (delay > 0) {
                if (unit === 'minutes') ms = delay * 60000;
                if (unit === 'hours') ms = delay * 3600000;
                if (unit === 'days') ms = delay * 86400000;
            }
            return Date.now() + ms;
        };

        const calculateTTL = () => {
             const daysValue = document.getElementById('ttl-days').value;
             let days = parseFloat(daysValue);
             
             // Se il valore è vuoto o non valido, usa il default (7 giorni)
             if (!daysValue || isNaN(days)) {
                 days = DEFAULT_TTL_DAYS; 
             }
             
             return new Date(Date.now() + (days * 86400000));
        };

        async function handleSendMessage() {
            if (!db || !location || !userId) return;
            const msgTxt = messageInput.value.trim();
            if (!msgTxt) return;

            try {
                await addDoc(collection(db, `artifacts/${USER_APP_ID}/public/data/bottles`), {
                    userId: userId,
                    message: msgTxt,
                    latitude: location.lat,
                    longitude: location.lng,
                    timestamp: serverTimestamp(),
                    unlockTimestamp: calculateUnlockTime(),
                    expireAt: calculateTTL()
                });
                messageInput.value = '';
                document.getElementById('delay-value').value = 0;
                document.getElementById('ttl-days').value = ''; // Reset to default "Seleziona"
                updatePresence();
                updateUIState();
            } catch (e) { console.error(e); }
        }

        async function deleteMessage(id) {
            if (!db || !userId || !id) return;
            if (!confirm("Sei sicuro di voler cancellare questo messaggio?")) return;
            try { await deleteDoc(doc(db, `artifacts/${USER_APP_ID}/public/data/bottles`, id)); } 
            catch(e) { alert("Errore cancellazione"); }
        }
        window.deleteMessage = deleteMessage;

        function setupDbListener() {
            const q = query(collection(db, `artifacts/${USER_APP_ID}/public/data/bottles`));
            if (window.mibIntervalId) clearInterval(window.mibIntervalId);
            window.mibIntervalId = setInterval(updateDisplay, 1000);

            function updateDisplay() {
                if (!messagesList.messages || !location) return;
                const now = Date.now();
                const visible = messagesList.messages.filter(msg => {
                    const dist = getDistance(location.lat, location.lng, msg.latitude, msg.longitude);
                    return dist <= PROXIMITY_RADIUS_METERS;
                }).sort((a,b) => b.timestamp - a.timestamp);
                
                messagesList.innerHTML = '';
                bottlesHeader.textContent = `Bottiglie Trovate (${visible.filter(m => m.unlockTimestamp <= now).length})`;
                
                if (visible.length === 0) {
                    messagesList.innerHTML = `<div class="p-5 bg-gray-800 rounded-xl text-center text-gray-400 border border-dashed border-gray-700">Nessuna bottiglia qui.</div>`;
                    return;
                }

                visible.forEach(msg => {
                    const isUnlocked = msg.unlockTimestamp <= now;
                    const isOwner = msg.userId === userId;
                    const dateStr = new Date(msg.timestamp).toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                    
                    const delBtn = isOwner ? `<button onclick="window.deleteMessage('${msg.id}')" class="absolute top-3 right-3 p-1 text-gray-500 hover:text-red-500 z-10">${getIcon('trash')}</button>` : '';
                    
                    let html = isUnlocked ? 
                        `${delBtn}<p class="text-gray-300 text-sm mb-2 italic pr-8">Da <span class="font-mono text-xs text-yellow-400">${isOwner?'Te':'Anonimo'}</span> il ${dateStr}</p><div class="border-l-4 border-green-500 pl-3"><p class="text-white text-lg break-words">${msg.message}</p></div>` :
                        `${delBtn}<div class="pr-8"><p class="text-sm font-semibold text-red-400 flex items-center space-x-2">${getIcon('clock')} APERTURA TRA: <span class="text-lg font-bold text-red-300 ml-1">${formatTimeRemaining(msg.unlockTimestamp - now)}</span></p></div>`;
                    
                    const div = document.createElement('div');
                    div.className = `p-4 rounded-xl shadow-lg border relative transition ${isUnlocked ? 'bg-gray-800 border-gray-700' : 'bg-red-900/40 border-red-700'}`;
                    div.innerHTML = html;
                    messagesList.appendChild(div);
                });
            }

            onSnapshot(q, (snapshot) => {
                messagesList.messages = snapshot.docs.map(d => ({id: d.id, ...d.data(), timestamp: d.data().timestamp?.toDate().getTime(), expireAt: d.data().expireAt?.toDate().getTime(), unlockTimestamp: d.data().unlockTimestamp || 0}));
                updateDisplay();
            });
        }

        window.onload = function() {
            initFirebaseAndAuth();
            document.getElementById('send-button').addEventListener('click', handleSendMessage);
            document.getElementById('message-input').addEventListener('input', updateUIState);
            document.getElementById('delay-value').addEventListener('input', updateUIState);
            document.getElementById('delay-unit').addEventListener('change', updateUIState);
            document.getElementById('ttl-days').addEventListener('change', updateUIState);
            updateUIState();
        };
    </script>
</body>
</html>
